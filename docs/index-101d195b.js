class t extends DOMPoint{add_(t){return this.addVectors(this,t),this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}set(t,e,i){return t&&"object"==typeof t&&(e=t.y,i=t.z,t=t.x),this.x=t??this.x,this.y=e??this.y,this.z=i??this.z,this}clone_(){return new t(this.x,this.y,this.z,this.w)}scale_(t){return this.x*=t,this.y*=t,this.z*=t,this}subtract(t){return this.subtractVectors(this,t),this}subtractVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}crossVectors(t,e){const i=t.y*e.z-t.z*e.y,r=t.z*e.x-t.x*e.z,s=t.x*e.y-t.y*e.x;return this.x=i,this.y=r,this.z=s,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}toArray(){return[this.x,this.y,this.z]}get magnitude(){return Math.hypot(...this.toArray())}normalize_(){const e=this.magnitude;return 0===e?new t:(this.x/=e,this.y/=e,this.z/=e,this)}moveTowards(e,i){const r=(new t).subtractVectors(e,this);if(r.magnitude>1){const t=r.normalize_().scale_(i);this.add_(t)}return this}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this}isEqualTo(t){return this.x===t.x&&this.y===t.y&&this.z===t.z}}const e=new class{constructor(){this.isConfirm=!1,this.isFlashlight=!1,this.prevConfirm=!1,this.prevFlash=!1,this.mouseMovement=new t,this.keyMap=new Map,document.addEventListener("keydown",(t=>this.keyMap.set(t.code,!0))),document.addEventListener("keyup",(t=>this.keyMap.set(t.code,!1))),document.addEventListener("mousedown",(()=>this.keyMap.set("KeyE",!0))),document.addEventListener("mouseup",(()=>this.keyMap.set("KeyE",!1))),document.addEventListener("mousemove",(t=>{this.mouseMovement.x=t.movementX,this.mouseMovement.y=t.movementY,this.onMouseMoveCallback?.(this.mouseMovement)})),this.inputDirection=new t}onMouseMove(t){this.onMouseMoveCallback=t}queryController(){this.prevConfirm=this.isConfirm,this.prevFlash=this.isFlashlight;const t=this.keyMap.get("KeyA")?-1:0,e=this.keyMap.get("KeyD")?1:0,i=this.keyMap.get("KeyW")?-1:0,r=this.keyMap.get("KeyS")?1:0;this.inputDirection.x=t+e,this.inputDirection.y=i+r,this.isConfirm=!!this.keyMap.get("KeyE"),this.isFlashlight=!!this.keyMap.get("KeyF")}};class i{constructor(t){this.texture=t?.texture}}const r=new class{constructor(){this.gl=c3d.getContext("webgl2");const t=this.createShader(35633,"#version 300 es\nlayout(location=0) in vec3 L;layout(location=1) in vec3 B;layout(location=2) in vec2 F;layout(location=3) in float H;uniform mat4 I,M,e,l;out vec2 o;out float n;out vec3 u;out mat4 h;out vec4 K;out vec3 t;void main(){vec4 v=vec4(L,1);gl_Position=I*v;o=F;n=H;u=B;h=M;K=e*v;t=(l*v).xyz;}"),e=this.createShader(35632,"#version 300 es\nprecision highp float;\nin vec2 o;in float n;in vec3 u;in mat4 h;in vec3 t;uniform vec3 v,d;vec4 s=vec4(1);uniform mediump sampler2DArray z;uniform mediump samplerCube x;uniform vec3 c,y;vec4 A=vec4(1,1,.8,1);float C=1.,D=.85;vec4 G=vec4(.05,.05,.05,1);out vec4 g;float p(float v,float m,float f,float h){return 1./(v*v*m+v*f+h);}void main(){vec3 m=t-v,l=v-t;float f=length(m);vec3 e=normalize(m),i=normalize(l);float B=texture(x,e).x*40.,E=.015,F=0.;F=B+E<f?0.:1.;vec3 H=normalize(mat3(h)*u);float I=max(0.,dot(i,H)),J=p(f,d.x,d.y,d.z);vec4 K=s*I*J*F;vec3 L=c-t,M=normalize(L);float N=length(L),O=max(0.,dot(M,H)),P=dot(y,-M),Q=smoothstep(D,C,P),R=p(N,.005,.001,.4);vec4 S=A*O*Q*R,T=clamp(G+K+S,G,vec4(1));g=texture(z,vec3(o,n))*T;}");this.program=this.createProgram(t,e);const i=this.createShader(35633,"#version 300 es\nprecision highp float;\nlayout(location=0) in vec4 i;uniform mat4 e,l;out vec3 f;void main(){gl_Position=e*i;f=vec3(l*vec4(i.xyz,1));}"),r=this.createShader(35632,"#version 300 es\nprecision highp float;\nuniform vec3 v;in vec3 f;out float m;void main(){m=length(f-v)/40.;}");this.depthProgram=this.createProgram(i,r);const s=this.gl.getUniformLocation(this.program,"x"),n=this.gl.getUniformLocation(this.program,"z");this.gl.useProgram(this.program),this.gl.uniform1i(n,0),this.gl.uniform1i(s,2)}createShader(t,e){const i=this.gl.createShader(t);return this.gl.shaderSource(i,e),this.gl.compileShader(i),i}createProgram(t,e){const i=this.gl.createProgram();return this.gl.attachShader(i,t),this.gl.attachShader(i,e),this.gl.linkProgram(i),i}},s=r.gl;class n{constructor(t,e){this.source=e,this.id=t}}const o=new class{constructor(){this.textures=[]}load_(t){const e=new n(this.textures.length,t);return this.textures.push(e),e}bindTextures(){s.activeTexture(s.TEXTURE0),s.bindTexture(35866,s.createTexture()),s.texStorage3D(35866,8,s.RGBA8,512,512,this.textures.length),this.textures.forEach(((t,e)=>{s.texSubImage3D(35866,0,0,0,e,512,512,1,s.RGBA,s.UNSIGNED_BYTE,t.source)})),s.generateMipmap(35866)}};async function a(t){const e=new Image;return e.src=URL.createObjectURL(new Blob([t],{type:"image/svg+xml"})),new Promise((t=>e.addEventListener("load",(()=>t(e)))))}const h={};function l(t=!1){return a(`<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512"><pattern id="b" width="128" height="128" patternUnits="userSpaceOnUse"><path fill="#687A5E" d="M0 0h128v128H0z"/>${t?'<text x="64" y="64" style="font-size:64px" stroke="#506546" fill="#506546">‚ùÄ</text><text y="128" style="font-size:50px" stroke="#506546" fill="#506546">‚ú¶</text>':""}</pattern><filter id="a"><feTurbulence baseFrequency=".4" stitchTiles="stitch"/><feDiffuseLighting color-interpolation-filters="sRGB" lighting-color="#687A5E"><feDistantLight azimuth="120" elevation="45"/></feDiffuseLighting><feBlend in="SourceGraphic" mode="difference"/></filter><rect width="100%" height="100%" filter="url(#a)" fill="url(#b)"/></svg>`)}async function c(){const t=[30,50,70];let e=70;const i=(t,e,i)=>`<ellipse cx="${t}%" cy="${e}%" rx="40" ry="40" fill="${i<13?"#777":"#ffa"}" stroke="black" stroke-width="4"></ellipse><text x="${t}%" dx="${i>9?-30:-14}" y="${e}%" dy="18" style="font-weight: bold; font-size: 60px;">${i}</text>`;let r=i(50,90,1);for(let s=0;s<12;s++){const n=s%3;s>0&&0===n&&(e-=20);r+=i(t[n],e,s+2)}return d(r,30)}function d(t="",e=1){const i=.01*e;return a(`<svg width="512" height="512" xmlns="http://www.w3.org/2000/svg"><filter id="b"><feTurbulence baseFrequency="0.01,0.0008" numOctaves="2" seed="23" type="fractalNoise" stitchTiles="stitch" /><feColorMatrix values="${i}, ${i}, ${i}, 0, 0,${i}, ${i}, ${i}, 0, 0,${i}, ${i}, ${i}, 0, 0,1, 1, 1, 1, 1"/></filter><rect x="0" y="0" width="100%" height="100%" filter="url(#b)"/>${t}</svg>`)}function u(t){return a(`<svg width="512" height="512" xmlns="http://www.w3.org/2000/svg"><rect x="0" y="0" width="100%" height="100%" fill="${t}"/></svg>`)}function m(t){return Math.floor((t.x+90)/15)+12*Math.floor((t.z+90)/15)}const p=new t(0,1,0),g=new t(0,-1,0);function f(t,e){for(const i of t){if(i.normal.isEqualTo(g)||i.normal.isEqualTo(p))continue;const t=w(e.collisionSphere,i);if(t){const r=t.penetrationNormal.scale_(t.penetrationDepth+1e-8);e.collisionSphere.center.add_(r);const s=t.penetrationNormal.scale_(e.velocity.dot(t.penetrationNormal));e.velocity.subtract(s),(i.normal.y>=.6&&e.velocity.y<0||i.normal.y<=-.6&&e.velocity.y>0)&&(e.velocity.y=0)}}}function w(e,i){if((new t).subtractVectors(e.center,i.points_[0]).dot(i.normal)<0)return;const r=function(e,i,r,s){const n=(new t).subtractVectors(r,i),o=(new t).subtractVectors(s,i),a=(new t).subtractVectors(e,i),h=n.dot(a),l=o.dot(a);if(h<=0&&l<=0)return i;const c=(new t).subtractVectors(e,r),d=n.dot(c),u=o.dot(c);if(d>=0&&u<=d)return r;const m=h*u-d*l;if(m<=0&&h>=0&&d<=0){const e=h/(h-d);return(new t).addVectors(i,(new t).set(n).scale_(e))}const p=(new t).subtractVectors(e,s),g=n.dot(p),f=o.dot(p);if(f>=0&&g<=f)return s;const w=g*l-h*f;if(w<=0&&l>=0&&f<=0){const e=l/(l-f);return(new t).addVectors(i,(new t).set(o).scale_(e))}const x=d*f-g*u;if(x<=0&&u-d>=0&&g-f>=0){const e=(u-d)/(u-d+(g-f)),i=(new t).subtractVectors(s,r).scale_(e);return(new t).addVectors(r,i)}const y=1/(x+w+m),_=w*y,v=m*y,P=(new t).set(n).scale_(_),b=(new t).set(o).scale_(v);return(new t).addVectors(P,b).add_(i)}(e.center,i.points_[0],i.points_[1],i.points_[2]),s=(new t).subtractVectors(e.center,r),n=s.dot(s);if(n<=e.radius*e.radius){return{penetrationNormal:s.normalize_(),penetrationDepth:e.radius-Math.sqrt(n)}}}const x=new AudioContext,y=x.createDynamicsCompressor(),_=x.createBiquadFilter();_.type="lowshelf",_.frequency.value=500,_.gain.value=20,_.connect(y),y.threshold.value=-50,y.knee.value=40,y.ratio.value=12,y.connect(x.destination);const v=.5*x.sampleRate,P={};P.n0=x.createBuffer(1,v,x.sampleRate),P.n1=x.createBuffer(1,v,x.sampleRate);for(let At=0;At<v;++At)P.n0.getChannelData(0)[At]=2*Math.random()-1;for(let At=0;At<64;++At){const t=10*Math.random()+1,e=10*Math.random()+1;for(let i=0;i<v;++i){const r=Math.sin(i/v*2*Math.PI*440*t)*Math.sin(i/v*2*Math.PI*440*e);P.n1.getChannelData(0)[i]+=r/8}}class b{constructor(){this.volume_=x.createGain(),this.modulator=x.createGain(),this.bend=0}playNote(t,e,i,r,s){let n,o;const a=[],h=[],l=[],c=[],d=440*2**((e-69)/12);for(let u=0;u<r.length;++u){const m=r[u];if(0===m.output?(n=this.volume_,o=i*i/16384,c[u]=d*m.t+m.f):a[m.output-1].frequency?(n=a[m.output-1].frequency,o=c[m.output-1],c[u]=c[m.output-1]*m.t+m.f):(n=a[m.output-1].playbackRate,o=c[m.output-1]/440,c[u]=c[m.output-1]*m.t+m.f),"n"===m.w[0])a[u]=x.createBufferSource(),a[u].buffer=P[m.w],a[u].loop=!0,a[u].playbackRate.value=c[u]/440,1!=m.p&&this._setParamTarget(a[u].playbackRate,c[u]/440*m.p,t,m.q),a[u].detune&&(this.modulator.connect(a[u].detune),a[u].detune.value=this.bend);else a[u]=x.createOscillator(),a[u].frequency.value=c[u],1!=m.p&&this._setParamTarget(a[u].frequency,c[u]*m.p,t,m.q),a[u].type=m.w,a[u].detune&&(this.modulator.connect(a[u].detune),a[u].detune.value=this.bend);h[u]=x.createGain(),m.r,a[u].connect(h[u]),h[u].connect(n),l[u]=o*m.v,m.k&&(l[u]*=2**((e-60)/12*m.k)),m.a?(h[u].gain.value=0,h[u].gain.setValueAtTime(0,t),h[u].gain.linearRampToValueAtTime(l[u],t+m.a)):h[u].gain.setValueAtTime(l[u],t);const p=t+m.a+m.h;this._setParamTarget(h[u].gain,m.s*l[u],p,m.d),a[u].start(t);for(let t=h.length-1;t>=0;--t)h[t].gain.cancelScheduledValues(m.d+s),this._setParamTarget(h[t].gain,0,s,m.d),a[u].stop(s+m.d)}}_setParamTarget(t,e,i,r){0!=r?t.setTargetAtTime(e,i,r):t.setValueAtTime(e,i)}}const M={output:0,w:"sine",t:1,f:0,v:.5,a:0,h:.01,d:.01,s:0,r:.05,p:1,q:1,k:0},S=[{...M,w:"triangle",v:.7,t:.5,d:.2,r:.2,p:.95},{...M,w:"n1",v:9,output:1,d:.2,r:.2}],T=[{...M,w:"sawtooth",v:.4,a:.1,d:.2},{...M,w:"sine",v:5,d:.2,s:.2,output:1}],N=[{...M,w:"square",v:.1,a:.1,d:.5,s:.5,r:.08},{...M,w:"sine",v:1,d:.1,s:4,output:1}],C=[{...M,w:"sawtooth",v:.4,a:.1,d:1,p:2,q:1.5},{...M,output:1,w:"n1",v:.8,f:11,d:11,s:.2}],A=[{...M,w:"n0",v:.2,a:.05,h:.02,d:.02,r:.02}],D=[{...M,w:"n0",p:0,r:.01,h:0,v:.3}],z=[{...M,w:"sine",f:1651,v:.15,d:.5,r:.2,h:0,t:0},{...M,w:"sawtooth",output:1,t:1.21,v:7.2,d:.1,r:11,h:1},{...M,output:1,w:"n0",v:3.1,t:.152,d:.002,r:.002}],E=[{...M,w:"sine",t:0,f:100,a:.2,d:1,r:2,s:1,q:7},{...M,output:1,w:"n1",v:.7,t:.9,d:1,s:1,r:1.5,f:40}],L=[{...M,w:"triangle",t:0,f:88,v:1,d:.05,h:.03,p:.5,q:.1},{...M,w:"n0",output:1,t:5,v:42,r:.01,h:0,p:0}],F=[{...M,w:"sine",t:0,f:90,v:1,d:1,h:.5,p:.5,q:.5,a:1,s:.5,r:1},{...M,w:"n0",output:1,t:5,v:3.6,r:1,h:.5,p:0,f:40,a:1,d:.75,s:.5}],V="2P(322P*322P,322P.322Q0322P2322P4322Q6322R8322R:322R<322R>322S@322RB322RD322SF322MH322MJ322ML322MN322NP322MR322MT322NV3235(B<32(B<3/(B<3/8B<3,8B<3)8B<36HB<33HB<30HB<".match(/.{5}/g).map((t=>[t.charCodeAt(0)-50,t.charCodeAt(1),(t.charCodeAt(2)-40)/8,(t.charCodeAt(3)-50)/8,t.charCodeAt(4)-20]));const I={pointLightPosition:new t(0,7,0),pointLightColor:new t(1,1,1),pointLightAttenuation:new t(.008,.01,.4),spotLightPosition:new t,spotLightDirection:new t,spotLightColor:new t(1,1,1)};class R{constructor(t,e){this.center=t,this.radius=e}}class B{constructor(i,r){this.feetCenter=new t,this.velocity=new t,this.isFrozen_=!1,this.cameraRotation=new t,this.isHiding=!1,this.hidFrom=new t,this.differenceFromNavPoint=new t,this.isFlashlightOn=!1,this.normal=new t,this.health=100,this.sfxPlayer=new b,this.sfxPlayer.volume_.connect(y),this.closestNavPoint=r,this.feetCenter.set(2,2.5,-2),this.collisionSphere=new R(this.feetCenter,2),this.camera=i,this.listener=x.listener;e.onMouseMove((t=>{this.isFrozen_||(this.cameraRotation.x+=-.001*t.y,this.cameraRotation.y+=-.001*t.x,this.cameraRotation.x=Math.min(Math.max(this.cameraRotation.x,-Math.PI/2),Math.PI/2),this.cameraRotation.y=this.cameraRotation.y%(2*Math.PI))}))}heal(){this.health+=50,this.health=Math.min(this.health,100)}hide(t){this.hidFrom.set(this.feetCenter),this.isHiding=!0,this.camera.position.set(t.position),this.cameraRotation.set(t.cameraRotation),this.sfxPlayer.playNote(x.currentTime,30,40,A,x.currentTime+1)}unhide(){this.isHiding=!1,this.feetCenter.set(this.hidFrom),this.sfxPlayer.playNote(x.currentTime,38,40,A,x.currentTime+1)}update(i){this.heldKeyRoomNumber&&-1!==this.heldKeyRoomNumber&&(tmpl.innerHTML+=`<div style="font-size: 30px; text-align: center; position: absolute; bottom: 50px; right: 80px;">üóùÔ∏è ${this.heldKeyRoomNumber}Âè∑Êàø</div>`),tmpl.innerHTML+=`<div style="font-size: 40px; text-align: center; position: absolute; bottom: 10px; right: 280px; color: #b00;">‚ô• <div style="position: absolute; bottom: 13px; left: 30px; width: ${2*this.health}px; height: 20px; background-color: #b00;"></div></div>`;let r=1/0;if([this.closestNavPoint,...this.closestNavPoint.getPresentSiblings()].forEach((e=>{const i=(new t).subtractVectors(this.feetCenter,e.position),s=i.magnitude;s<r&&(this.closestNavPoint=e,r=s,this.differenceFromNavPoint=i)})),this.isFrozen_||this.isHiding?this.velocity.set(0,0,0):this.updateVelocityFromControls(),this.isHiding)e.isConfirm&&!e.prevConfirm&&this.unhide();else{(function(t,e){const i=m(t);return[i,i-1-12,i-12,i+1-12,i-1,i+1,i-1+12,i+12,i+1+12].filter((t=>t>=0&&t<e))})(this.feetCenter,i.length).forEach((t=>f(i[t],this))),this.feetCenter.add_(this.velocity),this.feetCenter.y=2.5,this.camera.position.set(this.feetCenter),this.camera.position.y+=3.5}this.camera.setRotation_(...this.cameraRotation.toArray()),this.normal.set(0,0,-1),this.normal.set(this.camera.rotationMatrix.transformPoint(this.normal)),I.spotLightPosition.set(this.camera.position),I.spotLightDirection.set(this.normal),this.isFlashlightOn&&!this.isHiding||(I.spotLightPosition.y=-100),this.camera.updateWorldMatrix(),this.updateAudio()}updateVelocityFromControls(){const t=.24,i=Math.cos(this.cameraRotation.y)*e.inputDirection.y*t,r=Math.sin(this.cameraRotation.y)*e.inputDirection.y*t,s=Math.cos(this.cameraRotation.y+Math.PI/2)*e.inputDirection.x*t,n=Math.sin(this.cameraRotation.y+Math.PI/2)*e.inputDirection.x*t;this.velocity.z=i+s,this.velocity.x=r+n,this.velocity.normalize_().scale_(t),e.isFlashlight&&!e.prevFlash&&(this.sfxPlayer.playNote(x.currentTime,31+(this.isFlashlightOn?0:10),40,D,x.currentTime+1),this.isFlashlightOn=!this.isFlashlightOn)}updateAudio(){this.listener.positionX?(this.listener.positionX.value=this.camera.position.x,this.listener.positionY.value=this.camera.position.y,this.listener.positionZ.value=this.camera.position.z,this.listener.forwardX.value=this.normal.x,this.listener.forwardY.value=this.normal.y,this.listener.forwardZ.value=this.normal.z):(this.listener.setPosition(...this.camera.position.toArray()),this.listener.setOrientation(this.normal.x,this.normal.y,this.normal.z,0,1,0))}}function k(t){return t*(180/Math.PI)}function O(e){const i=e[2].clone_().subtract(e[1]),r=e[0].clone_().subtract(e[1]);return(new t).crossVectors(i,r)}class U{constructor(...e){this.rotation_=new t,this.isUsingLookAt=!1,this.right=new t,this.lookatUp=new t,this.forward=new t,this.position=new t,this.scale_=new t(1,1,1),this.children_=[],this.localMatrix=new DOMMatrix,this.worldMatrix=new DOMMatrix,this.up=new t(0,1,0),this.rotationMatrix=new DOMMatrix,e&&this.add_(...e)}add_(...t){t.forEach((t=>{t.parent_&&(t.parent_.children_=t.parent_.children_.filter((t=>t!==this))),t.parent_=this,this.children_.push(t)}))}remove_(t){this.children_=this.children_.filter((e=>e!==t))}rotate_(t,e,i){this.rotation_.add_({x:k(t),y:k(e),z:k(i)}),this.rotationMatrix.rotateSelf(k(t),k(e),k(i))}setRotation_(t,e,i){this.rotationMatrix=new DOMMatrix,this.rotation_.set(k(t),k(e),k(i)),this.rotationMatrix.rotateSelf(k(t),k(e),k(i))}getMatrix(){const t=new DOMMatrix;return t.translateSelf(this.position.x,this.position.y,this.position.z),this.isUsingLookAt?t.multiplySelf(this.rotationMatrix):t.rotateSelf(this.rotation_.x,this.rotation_.y,this.rotation_.z),t.scaleSelf(this.scale_.x,this.scale_.y,this.scale_.z),t}updateWorldMatrix(){this.localMatrix=this.getMatrix(),this.parent_?this.worldMatrix=this.parent_.worldMatrix.multiply(this.localMatrix):this.worldMatrix=DOMMatrix.fromMatrix(this.localMatrix),this.children_.forEach((t=>t.updateWorldMatrix()))}allChildren(){const t=[];return function t(e,i){e.children_.forEach((e=>{i.push(e),t(e,i)}))}(this,t),t}lookAt(t){this.isUsingLookAt=!0,this.forward.subtractVectors(this.position,t).normalize_(),this.right.crossVectors(this.up,this.forward).normalize_(),this.lookatUp.crossVectors(this.forward,this.right).normalize_(),this.rotationMatrix=new DOMMatrix([this.right.x,this.right.y,this.right.z,0,this.lookatUp.x,this.lookatUp.y,this.lookatUp.z,0,this.forward.x,this.forward.y,this.forward.z,0,0,0,0,1])}}class H extends U{constructor(){super(...arguments),this.solidMeshes=[]}add_(...t){super.add_(...t);[...t,...t.flatMap((t=>t.allChildren()))].forEach((t=>{t.geometry&&(t.geometry.bindGeometry(),this.solidMeshes.push(t))}))}remove_(t){super.remove_(t),[t,...t.allChildren()].forEach((t=>{t.geometry&&(this.solidMeshes=this.solidMeshes.filter((e=>e!==t)))}))}}class q extends U{constructor(t,e,i,r){super();const s=Math.tan(.5*Math.PI-.5*t),n=1/(i-r);this.projection=new DOMMatrix([s/e,0,0,0,0,s,0,0,0,0,(i+r)*n,-1,0,0,i*r*n*2,0])}}class W extends U{constructor(t,e){super(),this.geometry=t,this.material=e}}class G{constructor(t,e){this.points_=t,this.normal=e??function(t){return O(t).normalize_()}(t)}}var $=(t=>(t[t.Positions=0]="Positions",t[t.Normals=1]="Normals",t[t.TextureCoords=2]="TextureCoords",t[t.TextureDepth=3]="TextureDepth",t[t.LocalMatrix=4]="LocalMatrix",t[t.NormalMatrix=8]="NormalMatrix",t))($||{});s.enable(s.CULL_FACE),s.enable(s.DEPTH_TEST),s.blendFunc(s.SRC_ALPHA,771),s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!0),s.getExtension("EXT_color_buffer_float"),s.getExtension("OES_texture_float_linear");const K=s.getUniformLocation(r.program,"I"),X=s.getUniformLocation(r.program,"M"),j=s.getUniformLocation(r.program,"d"),Y=s.getUniformLocation(r.program,"c"),Z=s.getUniformLocation(r.program,"y"),Q=s.getUniformLocation(r.depthProgram,"l"),J=s.getUniformLocation(r.depthProgram,"v"),tt=s.getUniformLocation(r.depthProgram,"e"),et=s.getUniformLocation(r.program,"l"),it=s.getUniformLocation(r.program,"v");s.useProgram(r.program);const rt=new q(Math.PI/2,1,.1,60);const st=new class{constructor(t){this.size=t,s.activeTexture(s.TEXTURE2),this.depthTexture=s.createTexture(),s.bindTexture(3553,this.depthTexture),s.texStorage2D(3553,1,s.DEPTH_COMPONENT32F,t,t),this.cubeMapTexture=s.createTexture(),s.bindTexture(34067,this.cubeMapTexture),s.texParameteri(34067,10241,s.LINEAR),s.texParameteri(34067,10240,s.LINEAR),s.texParameteri(34067,s.TEXTURE_WRAP_S,33071),s.texParameteri(34067,s.TEXTURE_WRAP_T,33071),s.texParameteri(34067,s.TEXTURE_WRAP_R,33071);for(let e=0;e<6;e++)s.texImage2D(34069+e,0,s.RGBA32F,t,t,0,s.RGBA,s.FLOAT,null);this.depthFramebuffer=s.createFramebuffer(),s.bindFramebuffer(36160,this.depthFramebuffer),s.framebufferTexture2D(36160,s.DEPTH_ATTACHMENT,3553,this.depthTexture,0),s.readBuffer(s.NONE)}bindForWriting(t){s.activeTexture(s.TEXTURE2),s.bindFramebuffer(36160,this.depthFramebuffer),s.viewport(0,0,this.size,this.size),s.framebufferTexture2D(36160,36064,34069+t,this.cubeMapTexture,0)}getSides(){return[{target:new t(1,0,0),up:new t(0,-1,0)},{target:new t(-1,0,0),up:new t(0,-1,0)},{target:new t(0,1,0),up:new t(0,0,1)},{target:new t(0,-1,0),up:new t(0,0,-1)},{target:new t(0,0,1),up:new t(0,-1,0)},{target:new t(0,0,-1),up:new t(0,-1,0)}]}}(1024);function nt(e,i){const n=e.worldMatrix.inverse(),o=e.projection.multiply(n);s.useProgram(r.depthProgram),s.disable(s.BLEND),s.uniform3fv(J,I.pointLightPosition.toArray()),st.getSides().forEach(((e,r)=>{st.bindForWriting(r),s.clearColor(1,1,1,1),s.clear(16640);const n=function(e,i,r){const s=(new t).subtractVectors(i,e).normalize_(),n=(new t).crossVectors(s,r).normalize_(),o=(new t).crossVectors(n,s),a=new t(-1*s.x,-1*s.y,-1*s.z);return new DOMMatrix([n.x,o.x,a.x,0,n.y,o.y,a.y,0,n.z,o.z,a.z,0,-n.dot(e),-o.dot(e),-a.dot(e),1])}(I.pointLightPosition,(new t).addVectors(I.pointLightPosition,e.target),e.up),o=rt.projection.multiply(n);i.solidMeshes.forEach(((t,e)=>{s.bindVertexArray(t.geometry.vao),s.uniformMatrix4fv(Q,!1,t.worldMatrix.toFloat32Array()),s.uniformMatrix4fv(tt,!1,o.multiply(t.worldMatrix).toFloat32Array()),s.drawElements(s.TRIANGLES,t.geometry.getIndices().length,5123,0)}))})),s.useProgram(r.program),s.enable(s.BLEND),s.uniform3fv(it,I.pointLightPosition.toArray()),s.uniform3fv(Y,I.spotLightPosition.toArray()),s.uniform3fv(Z,I.spotLightDirection.toArray()),s.uniform3fv(j,I.pointLightAttenuation.toArray()),s.activeTexture(s.TEXTURE0),s.texParameteri(35866,10241,9987),s.viewport(0,0,s.canvas.width,s.canvas.height),s.bindFramebuffer(36160,null),s.cullFace(s.BACK),s.clearColor(0,0,0,0),s.clear(16640),i.solidMeshes.forEach((t=>{s.useProgram(r.program);const e=o.multiply(t.worldMatrix);s.vertexAttrib1f(3,t.material.texture?.id??-1),s.bindVertexArray(t.geometry.vao),s.uniformMatrix4fv(X,!0,t.color?t.cachedMatrixData:t.worldMatrix.inverse().toFloat32Array()),s.uniformMatrix4fv(et,!1,t.worldMatrix.toFloat32Array()),s.uniformMatrix4fv(K,!1,e.toFloat32Array()),s.drawElements(s.TRIANGLES,t.geometry.getIndices().length,5123,0)})),s.bindVertexArray(null)}function ot(e,i,r){return(new t).set(r.transformPoint(new t(i[e],i[e+1],i[e+2])))}function at(t){return t.flatMap((t=>{const e=t.geometry.getIndices(),i=t.geometry.getAttribute_($.Positions),r=[];for(let s=0;s<e.length;s+=3){const n=3*e[s],o=3*e[s+1],a=3*e[s+2],h=[ot(n,i.data,t.worldMatrix),ot(o,i.data,t.worldMatrix),ot(a,i.data,t.worldMatrix)];r.push(h)}return r.map((t=>new G(t)))}))}function ht(t,e,i){return new Array((t+1)*(e+1)).fill().map((t=>i.texture.id))}class lt{constructor(e=1,i=1,r=1,n=1,o=1,a=1,h=6){this.vertices=[],this.verticesToActOn=[],this.buffers=new Map,this.widthSegments=n,this.depthSegments=a,this.heightSegments=o,this.vao=s.createVertexArray();const l=[],c=[];let d=0;const u=(e,i,r,s,n,o,a,h,u,m)=>{const p=o/u,g=a/m,f=o/2,w=a/2,x=h/2,y=u+1,_=m+1;for(let l=0;l<_;l++){const o=l*g-w;for(let a=0;a<y;a++){const h=a*p-f,d=new t;d[e]=h*s,d[i]=o*n,d[r]=x,this.vertices.push(d),c.push(a/u,1-l/m)}}for(let t=0;t<m;t++)for(let e=0;e<u;e++){const i=d+e+y*t,r=d+e+y*(t+1),s=d+(e+1)+y*(t+1),n=d+(e+1)+y*t;l.push(i,r,n,r,s,n)}d+=y*_},m=[["x","z","y",1,1,e,r,i,n,a],["x","z","y",1,-1,e,r,-i,n,a],["z","y","x",-1,-1,r,i,e,a,o],["z","y","x",1,-1,r,i,-e,a,o],["x","y","z",1,-1,e,i,r,n,o],["x","y","z",-1,-1,e,i,-r,n,o]];for(let t=0;t<h;t++)u(...m[t]);this.setAttribute_($.TextureCoords,new Float32Array(c),2),this.indices=new Uint16Array(l),this.computeNormals().done_().all_()}texturePerSide(t,e,i,r,s,n){const o=[...ht(this.depthSegments,this.heightSegments,t),...ht(this.depthSegments,this.heightSegments,e??t),...ht(this.widthSegments,this.depthSegments,i??t),...ht(this.widthSegments,this.depthSegments,r??t),...ht(this.widthSegments,this.heightSegments,s??t),...ht(this.widthSegments,this.heightSegments,n??t)];return this.setAttribute_($.TextureDepth,new Float32Array(o),1),this}all_(){return this.verticesToActOn=this.vertices,this}invertSelection(){return this.verticesToActOn=this.vertices.filter((t=>!this.verticesToActOn.includes(t))),this}selectBy(t){return this.verticesToActOn=this.vertices.filter(t),this}translate_(t=0,e=0,i=0){return this.verticesToActOn.forEach((r=>r.add_({x:t,y:e,z:i}))),this}scale_(t=1,e=1,i=1){const r=(new DOMMatrix).scaleSelf(t,e,i);return this.verticesToActOn.forEach((t=>t.set(r.transformPoint(t)))),this}rotate_(t=0,e=0,i=0){const r=(new DOMMatrix).rotateSelf(k(t),k(e),k(i));return this.verticesToActOn.forEach((t=>t.set(r.transformPoint(t)))),this}modifyEachVertex(t){return this.verticesToActOn.forEach(t),this}spherify(t){return this.modifyEachVertex((e=>{e.normalize_().scale_(t)})),this}merge(t){const e=t.getIndices().map((t=>t+this.vertices.length));this.indices=new Uint16Array([...this.indices,...e]),this.vertices.push(...t.vertices);const i=this.getAttribute_($.TextureCoords).data,r=t.getAttribute_($.TextureCoords).data,s=new Float32Array([...i,...r]);this.setAttribute_($.TextureCoords,s,2);const n=this.getAttribute_($.Normals).data,o=t.getAttribute_($.Normals).data,a=new Float32Array([...n,...o]);if(this.setAttribute_($.Normals,a,3),this.getAttribute_($.TextureDepth)){const e=this.getAttribute_($.TextureDepth).data,i=t.getAttribute_($.TextureDepth).data,r=new Float32Array([...e,...i]);this.setAttribute_($.TextureDepth,r,1)}return this}cylindrify(t,e="y",i={x:0,y:0,z:0}){return this.modifyEachVertex((r=>{const s=r[e];r[e]=0,r.subtract(i).normalize_().scale_(t),r[e]=s})),this}spreadTextureCoords(t=12,e=12,i=0,r=0){const s=(t,e)=>(t-1+2)*(e-1+2)*2,n=s(this.widthSegments,this.depthSegments),o=n+s(this.depthSegments,this.heightSegments),a=this.getAttribute_($.TextureCoords).data;let h,l;return this.vertices.forEach(((s,c)=>{c<n?(h=s.x,l=s.z):c<o?(h=s.z,l=s.y):(h=s.x,l=s.y);const d=[h/t+i,l/e+r];a.set(d,2*c)})),this.setAttribute_($.TextureCoords,a,2),this}computeNormals(e=!1){const i=this.vertices.map((e=>new t)),r=e?this.getIndicesWithUniquePositions():this.indices;for(let t=0;t<r.length;t+=3){const e=O([this.vertices[r[t]],this.vertices[r[t+1]],this.vertices[r[t+2]]]);i[r[t]].add_(e),i[r[t+1]].add_(e),i[r[t+2]].add_(e)}return this.setAttribute_($.Normals,new Float32Array(i.flatMap((t=>t.normalize_().toArray()))),3),this}getIndicesWithUniquePositions(){const t=[],e=this.indices.slice();return this.verticesToActOn.forEach((i=>{if(t.find((t=>i.isEqualTo(t))))return;t.push(i);const r=this.vertices.findIndex((t=>i.isEqualTo(t)));this.vertices.forEach(((t,s)=>{if(i.isEqualTo(t)){const t=e.indexOf(s);e[t]=r}}))})),e}done_(){return this.setAttribute_($.Positions,new Float32Array(this.vertices.flatMap((t=>t.toArray()))),3),this}getAttribute_(t){return this.buffers.get(t)}setAttribute_(t,e,i){return this.buffers.set(t,{data:e,size:i}),this}getIndices(){return this.indices}bindGeometry(){const t=[...this.buffers.values()].reduce(((t,e)=>t+e.data.length),0),e=new Float32Array(t);s.bindBuffer(34962,s.createBuffer()),s.bindVertexArray(this.vao);let i=0,r=0;this.buffers.forEach(((t,n)=>{s.vertexAttribPointer(n,t.size,s.FLOAT,!1,0,i),s.enableVertexAttribArray(n),e.set(t.data,r),i+=t.data.length*t.data.BYTES_PER_ELEMENT,r+=t.data.length})),s.bufferData(34962,e,s.STATIC_DRAW),s.bindBuffer(34963,s.createBuffer()),s.bufferData(34963,this.indices,s.STATIC_DRAW)}}function ct(t,e,i,r,s=1,n=12,o){let a,h=0,l=0,c=0;return i.forEach(((i,h)=>{const d=t[h];if(i>0){const t=new lt(d,i,s,1,1,1,6).translate_(l+(0===h?0:d/2),e-i/2).spreadTextureCoords(n,n);o&&t.texturePerSide(...o),a?a.merge(t):a=t}if(r[h]>0){const t=new lt(d,r[h],s,1,1,1,6).translate_(l+(0===h?0:d/2),r[h]/2).spreadTextureCoords(n,n);o&&t.texturePerSide(...o),a?a.merge(t):a=t}l+=0===h?d/2:d,c+=d})),h=c,a&&a.all_().translate_((t[0]-c)/2,0).computeNormals().done_(),[a,h]}function dt(t,e,i){return t?.translate_(0,0,i),e?.translate_(0,0,-i),t&&e?t.merge(e).done_():t??e}function ut(t,e,i,r){return dt(t[0],e[0],(i[1]+1)/2).merge(dt(i[0],r[0],(t[1]-1)/2).rotate_(0,Math.PI/2)).computeNormals().done_()}class mt{constructor(){this.isOpen=!1,this.isOpenTriggered=!1,this.isCloseTriggered=!1;const t=ct([4,7.9,4],12,[12,3,12],[0,0,0],1),e=ct([16],12,[12],[],1),i=ct([10],12,[12],[],1),r=ct([10],12,[12],[],1),s=new W(ut(t,e,i,r),h.silver),n=new W(new lt(10,.5,.3).translate_(0,4,-4).merge(new lt(.3,.5,6).translate_(-6,4,0)).merge(new lt(.3,.5,6).translate_(6,4,0)).done_(),h.silver),o=new W(new lt(1.5,2,1).translate_(5.4,5,5.2).spreadTextureCoords(-2,2,.2).translate_(0,0,.2).computeNormals().done_(),h.elevatorPanel),a=[1.25,4,.5,4,.5,4,1.25],l=[.5,4,.5,4,.5],c=new W(ut(ct([a.reduce(((t,e)=>t+e))],9,[0],[0]),ct(a,9,[0,9,0,9,0,9,0],[0]),ct(l,9,[0,9,0,9,0],[0]),ct(l,9,[0,9,0,9,0],[0])).translate_(0,1.25).done_(),h.wood),d=new W(new lt(15,1.5,10.5).spreadTextureCoords(5,5),h.marble),u=new W(new lt(15,1.5,10).translate_(0,12).done_().spreadTextureCoords(),h.ceilingTiles),m=new W(new lt(4,9,.5).translate_(-2,4.5,5.5).done_(),h.silver),p=new W(new lt(4,9,.5).translate_(2,4.5,5.5).done_(),h.silver);this.bodyCollision=s,this.doorCollision=new Set(at([m,p])),this.meshes=[s,n,d,u,c,o,m,p],this.openDoors=()=>{m.position.x>-5?(m.position.x-=.035,p.position.x+=.035):this.isOpenTriggered=!1,this.isOpen=m.position.x<-1},this.closeDoors=()=>{m.position.x<0?(m.position.x+=.04,p.position.x-=.04):this.isCloseTriggered=!1,this.isOpen=m.position.x<-1}}update(){this.isOpenTriggered?this.openDoors():this.isCloseTriggered&&this.closeDoors()}}function pt(t,e=!1,i=!1){const r=ct([3,5,15],12,[12,3,12],[0,0,0],1,4,[h.greenPlasterWall,h.greenPlasterWall,h.greenPlasterWall,h.greenPlasterWall,h.greenPlasterWall,h.wallpaper]),s=ct([23],12,[12],[],1,4,[h.wallpaper,h.wallpaper,h.wallpaper,h.wallpaper,h.wallpaper,h.greenPlasterWall]),n=ct([34],12,[12],[],1,4,[h.wallpaper,h.wallpaper,h.wallpaper,h.wallpaper,h.wallpaper,h.greenPlasterWall]),o=ct([34],12,[12],[],1,4,[h.wallpaper]),[a]=ct([4,5,4],12,[12,3,12],[],1,4,[h.greenPlasterWall]);a.rotate_(0,Math.PI).translate_(-10).computeNormals();const l=new lt(1,12,11.5).texturePerSide(h.greenPlasterWall).translate_(-4,6,-6.25).spreadTextureCoords(4,4),c=new lt(3,12,4).texturePerSide(h.greenPlasterWall).translate_(-6,6,-9.5).spreadTextureCoords(4,4),d=new lt(9,3,1).texturePerSide(h.greenPlasterWall).merge(new lt(12,.5,1.5).translate_(2,1.25).texturePerSide(h.wood)).translate_(-12,10,-8).spreadTextureCoords(4,4),u=new lt(7,2,8).translate_(6,2,-6.5).texturePerSide(h.white).done_(),m=new lt(3,1,7).translate_(-5.5,3,-4).texturePerSide(h.white).done_(),p=new lt(2,3,4.75).translate_(-14.5,1.5,-.25).texturePerSide(h.white).done_(),g=new lt(7,5,3).translate_(-11.5,3,-9).texturePerSide(h.white).done_(),f=new lt(4,8,6).translate_(14,4,5).texturePerSide(h.white).done_(),w=new lt(10,2,8).translate_(-11,-.4,-4).spreadTextureCoords(6,6,-.03).texturePerSide(h.marble),x=new lt(3,1,7,12,1,12).selectBy((t=>t.y>0&&Math.hypot(t.x,t.z)<1)).spherify(1).translate_(0,-.5).modifyEachVertex((t=>t.y*=-1)).translate_(0,.4,0).selectBy((t=>t.y>-.5&&Math.hypot(t.x,t.z)<1.3)).translate_(-.2).texturePerSide(h.white).all_().merge(new lt(1,1,1,2,1,2).cylindrify(.2).translate_(1.1,.3,-.5).texturePerSide(h.silver)).merge(new lt(1,1,1,2,1,2).cylindrify(.2).translate_(1.1,.3,.5).texturePerSide(h.silver)).merge(new lt(1,.2,.4).translate_(.7,.7).texturePerSide(h.silver)).merge(new lt(3,3,7).translate_(.1,-2).texturePerSide(h.wood)).merge(new lt(1,4,4).translate_(1.5,3.2).texturePerSide(h.silver)).translate_(-6,3.2,-4).computeNormals(!0).done_(),y=ut([new lt(8.5,3,.5).texturePerSide(h.white),9.75],[new lt(8.5,15,.5).texturePerSide(h.white),9.75],[new lt(3.75,15,.5).texturePerSide(h.white),2.5],[new lt(3.75,15,.5).texturePerSide(h.white),2.5]).merge(new lt(8.5,.5,3).texturePerSide(h.white)).merge(new lt(1,1,1,1,3,3).cylindrify(.1,"x").selectBy((t=>t.x<0)).scale_(1,3,3).all_().rotate_(0,0,.5).translate_(3.75,6.5).texturePerSide(h.silver)).merge(new lt(6,7,.1,10,1,1).modifyEachVertex((t=>t.z=.3*Math.sin(3*t.x))).translate_(-.5,3.75,2.5).rotate_(-.1).texturePerSide(h.white)).translate_(-11.75,1,-9.5).computeNormals().done_(),_=new lt(.2,8,6).translate_(1.5).texturePerSide(h.wood).merge(new lt(3,.2,6).translate_(0,-4).texturePerSide(h.wood)).merge(new lt(3,.2,6).translate_(0,4).texturePerSide(h.wood)).merge(new lt(3,8.2,.2).translate_(0,0,3.1).texturePerSide(h.wood)).merge(new lt(3,8.2,.2).translate_(0,0,-3.1).texturePerSide(h.wood)).merge(new lt(.2,8,3).translate_(-.5,0,-1.75).rotate_(0,.25).texturePerSide(h.wood)).merge(new lt(.2,8,3).translate_(-2.75,0,.8).rotate_(0,.5).texturePerSide(h.wood)).translate_(14,4.5,5).done_(),v=()=>new lt(1,1,1,4,3,4).spherify(1).selectBy((t=>Math.abs(t.x)>.8||Math.abs(t.z)>.8)).scale_(.8,1,.8).all_().scale_(2,.3).rotate_(.5).translate_(0,1.3,-3.5).texturePerSide(h.white).computeNormals(!0).done_(),P=new lt(7,2,7,8,1,8).selectBy((t=>Math.hypot(t.x,t.z)>4.5)).scale_(.9,1,.9).selectBy((t=>Math.hypot(t.x,t.z)>3)).scale_(1,.9,1).all_().scale_(1,1,1.2).texturePerSide(h.white).merge(v().translate_(-1.5)).merge(v().translate_(1.5)).computeNormals(!0).merge(new lt(7,7,.5).translate_(0,0,-4.5).texturePerSide(h.wood).merge(new lt(7,1,8.5).translate_(0,-1.5).texturePerSide(h.wood)).computeNormals()).translate_(6,2,-6.5).done_(),b=new lt(2,2,2,6,2,6).cylindrify(1).scale_(1,1,1.2).selectBy((t=>0===t.y)).scale_(.7,1,.7).translate_(0,-.5).texturePerSide(h.white).merge(new lt(2,2,1).translate_(0,1.5,1.5).texturePerSide(h.white)).all_().translate_(-14.5,1.5,-2.25).done_();function M(){const t=new lt(3,3,2).texturePerSide(h.wood);return i&&t.merge(new lt(1,.2).translate_(0,1,.6).texturePerSide(h.silver)),t.computeNormals().done_()}const S=M().translate_(-.25,1.5,-9.5),T=M().translate_(12.25,1.5,-9.5),N=M().merge(M().translate_(3)).merge(M().translate_(-3)).rotate_(0,3.14).translate_(0,1.5,10);const C=ct([3,5,15],12,[1,1,1],[1,0,1],1.5,4,[h.wood]),A=ct([23],12,[1],[1],1.5,4,[h.wood]),D=ct([34],12,[1],[1],1.5,4,[h.wood]),z=ct([34],12,[1],[1],1.5,4,[h.wood]),E=ct([4.25,4.5,4.25],12,[1,1,1],[1,0,1],1.5,4,[h.wood]),L=ct([12],12,[1],[1],1.5,4,[h.wood]),F=ct([.5,4.5,.5],9,[12,.5,12],[],1.5,4,[h.wood]),V=ut(D,z,A,C).merge(E[0].rotate_(0,Math.PI).translate_(-10)).merge(L[0].rotate_(0,Math.PI/2).translate_(-4,0,-5.25)).merge(F[0].rotate_(0,Math.PI/2).translate_(-16.5,0,6)).merge(w).merge(new lt(1,3.5,3).texturePerSide(h.wood).spreadTextureCoords(4,4).translate_(-16.6,2.5,10).merge(new lt(1,3.5,15).texturePerSide(h.wood).spreadTextureCoords(4,4).translate_(-16.6,2.5,-4)).merge(new lt(1,3.5,23).texturePerSide(h.wood).spreadTextureCoords(4,4).translate_(16.6,2.5,0)).merge(new lt(33,3.5,1).texturePerSide(h.wood).spreadTextureCoords(4,4).translate_(0,2.5,12.1)).merge(new lt(33,3.5,1).texturePerSide(h.wood).spreadTextureCoords(4,4).translate_(0,2.5,-12.1))).computeNormals().done_(),I=new lt(1,1).texturePerSide(h[t]).translate_(-16.6,5,e?9.5:2.5),R=ut(n,o,s,r).merge(a).merge(l).merge(c).merge(d);return i?R.merge(V).merge(I).merge(_).merge(x).merge(y).merge(P).merge(b).merge(S).merge(T).merge(N):R.merge(u).merge(f).merge(m).merge(p).merge(g).merge(S).merge(T).merge(N)}function gt(t=!1){const e=pt(1,!1,t).translate_(0,0,10).merge(pt(2,!1,t).translate_(0,0,45)).merge(pt(3,!1,t).translate_(0,0,80)).merge(pt(5,!1,t).translate_(-44,0,10)).merge(pt(7,!1,t).translate_(-44,0,45)).merge(pt(9,!1,t).translate_(-44,0,80)).merge(pt(4,!0,t).rotate_(0,Math.PI).translate_(-88,0,10)).merge(pt(6,!0,t).rotate_(0,Math.PI).translate_(-88,0,45)).merge(pt(8,!0,t).rotate_(0,Math.PI).translate_(-88,0,80)).merge(pt(10,!0,t).rotate_(0,Math.PI).translate_(-132,0,10)).merge(pt(11,!0,t).rotate_(0,Math.PI).translate_(-132,0,45)).merge(pt(12,!0,t).rotate_(0,Math.PI).translate_(-132,0,80)).translate_(66,0,14).merge(ct([45,11,45],12,[12,2,12],[],1,4,[h.wallpaper])[0]).merge(ct([45,11,45],12,[12,3,12],[],1,4,[h.wallpaper])[0].merge(ct([.5,10,.5],9,[12,.5,12],[],1.5,12,[h.wood])[0]).merge(new lt(2,1.5).texturePerSide(h[13]).translate_(0,10,-.1)).merge(ut([new lt(20,12,.5).texturePerSide(h.wallpaper).spreadTextureCoords(6,6),20],[new lt(20,12,.5).texturePerSide(h.wallpaper).spreadTextureCoords(6,6),20],[new lt(19.5,12,.5).texturePerSide(h.wallpaper).spreadTextureCoords(6,6),19],[new lt(19.5,12,.5).texturePerSide(h.wallpaper).spreadTextureCoords(6,6),19]).translate_(0,6,10)).merge(new lt(3,3.25,3).translate_(0,1.5,15).texturePerSide(h.wood)).translate_(0,0,118)).merge(ct([11,25,10,25,10,25,11],12,[12,0,12,0,12,0,12],[],1,4,[h.wallpaper])[0].rotate_(0,Math.PI/2).translate_(49.5,0,59)).merge(ct([11,25,10,25,10,25,11],12,[12,0,12,0,12,0,12],[],1,4,[h.wallpaper])[0].rotate_(0,Math.PI/2).translate_(-49.5,0,59)).done_();return t&&e.merge(function(){const t=[-44,0,44].map((t=>ft(t,0).merge(ft(t,24.25)).merge(ft(t,35)).merge(ft(t,59.25)).merge(ft(t,70)).merge(ft(t,94.25))));return t[0].merge(t[1]).merge(t[2])}()).computeNormals(),e}function ft(t,e){return ct([.75,9.5,.75],12,[12,1,12],[],1.25,4,[h.wood])[0].translate_(t,0,11.875+e)}class wt extends U{constructor(e,r,s,n=1,o=1,a,l){super(new W(new lt(5,7.75,.25).texturePerSide(h.wood).merge(new lt(1,1,1,4,4).cylindrify(.2,"z").translate_(2*n,-.5).texturePerSide(h.silver)).done_(),h.white)),this.originalRot=0,this.isLocked=!1,this.openClose=-1,this.isAnimating=!1,this.speed_=3,this.sfxPlayer=new b,this.isLocked=!!l,this.placedPosition=new t(e-(a?2*n:0),r,s-(a?2*n:0)),this.swapHingeSideX=n,this.swapHingeSideZ=o,this.sfxPlayer.volume_.connect(y),this.position.set(e-2*n,r,s),this.children_[0].position.x=2*n,this.collisionMesh=new W(new lt(a?1:4,7,a?4:1).translate_(e-(a?2*n:0),r,s-(a?2*n:0)).done_(),new i),this.placedPosition.y-=3,this.closedDoorCollision=new Set(at([this.collisionMesh])),a&&(this.rotation_.y=90,this.originalRot=90)}pullLever(t=!1){this.speed_=t?1:3,this.isAnimating||(this.isAnimating=!0,this.openClose*=-1,this.sfxPlayer.playNote(x.currentTime,10,40,L,x.currentTime+1),t&&this.sfxPlayer.playNote(x.currentTime,72,20,C,x.currentTime+1))}update_(){this.isAnimating&&(this.rotation_.y+=this.swapHingeSideZ*this.swapHingeSideX*this.speed_*this.openClose,Math.abs(this.rotation_.y)-this.originalRot==(-1===this.openClose?0:120)&&(this.isAnimating=!1))}}class xt{constructor(t,e,i,r){this.position=t,this.door=e,this.roomNumber=i,this.hidingPlace=r}getAllSiblings(){return[this.aboveSibling,this.belowSibling,this.rightSibling,this.leftSibling]}getPresentSiblings(){return this.getAllSiblings().filter((t=>void 0!==t))}attachThisRightToOtherLeft(t){this.rightSibling=t,t.leftSibling=this}attachThisLeftToOtherRight(t){this.leftSibling=t,t.rightSibling=this}insertBetweenVert(t,e){this.aboveSibling=t,this.belowSibling=e,t.belowSibling=this,e.aboveSibling=this}insertBetweenHor(t,e){this.leftSibling=t,this.rightSibling=e,t.rightSibling=this,e.leftSibling=this}}class yt{constructor(t,e){this.position=t,this.cameraRotation=e}}class _t{constructor(t,e,i){this.isTaken=!1,this.roomNumber=i,this.roomNumber?-1===this.roomNumber?this.mesh=new W(ct([.5,2,.5,2,.5],2,[2,.5,2,.5,2],[],1,4,[h.red])[0].merge(new lt(5.5,.5).texturePerSide(h.red).translate_(0,-2,0)).rotate_(0,0,-Math.PI/2).merge(new lt(3,4,3,8,1,8).cylindrify(6).all_().translate_(0,-5.5).texturePerSide(h.white)).merge(new lt(4,1,4,8,1,8).cylindrify(8).all_().translate_(0,-8).texturePerSide(h.white)).rotate_(0,Math.PI).scale_(.1,.1,.1).computeNormals().done_(),h.silver):this.mesh=new W(new lt(1,1,.5,3,3).cylindrify(.75,"z").merge(ct([1,.5,.5,.5],1,[.25,1,.25,1],[0],.3)[0].translate_(1.75,-.75)).scale_(.5,.5,.5).translate_(-.5).done_(),h.silver):this.mesh=new W(new lt(1.9,1,.5).texturePerSide(h.white).merge(new lt(.75,.2,.75).texturePerSide(h.red)).merge(new lt(.2,.75,.75).texturePerSide(h.red)).done_(),h.wood),this.mesh.position.set(t),this.mesh.setRotation_(e.x,e.y,e.z),this.mesh.updateWorldMatrix()}}const vt=[],Pt=[],bt=[1304,1306,1308,1310,1311,1312];function Mt(e,i,r,s){const n=bt.includes(i),o=new xt(e,r,i),a=new t(12,0,-1),h=new t(27,0,-3),l=new t(35.5,0,.5),c=new t(12.75,0,-15);n&&(a.scale_(-1),h.scale_(-1),l.scale_(-1),c.scale_(-1));const d=new xt(new t(e.x+a.x,e.y,e.z+a.z),r,i,new yt(new t(e.x+c.x,5.5,e.z+c.z),new t(0,n?0:3.14))),u=new xt(new t(e.x+h.x,e.y,e.z+h.z),void 0,i,new yt(new t(e.x+l.x,5.5,e.z+l.z),new t(0,n?-1.7:1.7)));return d.insertBetweenHor(n?o:u,n?u:o),o}class St{constructor(t,...e){this.currentState=t,this.currentState.onEnter?.(...e)}setState(t,...e){this.currentState.onLeave?.(),this.currentState={onUpdate:()=>{}},t.onEnter?.(...e),this.currentState=t}getState(){return this.currentState}}class Tt{constructor(){this.spotSearchFrameCount=0,this.spotsSearched=0,this.pathCache=[],this.positionInPathCache=0,this.lastPlayerNode=null,this.travelingDirection=new t,this.nextNodeDifference=new t,this.nextNodeDistance=0,this.nextNodeDirection=new t,this.currentNodeDifference=new t,this.songInterval=0,this.currentInterval=0,this.footstepPlayer=new b,this.pannerNode=new PannerNode(x,{distanceModel:"linear",maxDistance:80,rolloffFactor:99,coneOuterGain:.1}),this.unseenFrameCount=0,this.aggression=0,this.songPlayer=new b,this.lightObject=new U,this.footstepDebounce=null,this.isSpawned=!1,this.killFrames=300,this.killFrameCount=0,this.farthestPoint=vt[0],this.songPlayer.volume_.connect(_),this.footstepPlayer.volume_.connect(this.pannerNode).connect(y),this.currentNode=vt[2],this.position=(new t).set(this.currentNode.position),this.nextNode=this.currentNode,this.patrolState={onEnter:()=>{this.stopSong()},onUpdate:t=>this.patrolUpdate(t)},this.chaseState={onEnter:t=>this.chaseEnter(t),onUpdate:t=>this.chaseUpdate(t)},this.searchState={onEnter:()=>this.searchEnter(),onUpdate:t=>this.searchUpdate(t)},this.fleeState={onEnter:t=>this.fleeEnter(t),onUpdate:()=>this.fleeUpdate()},this.killState={onUpdate:t=>this.killUpdate(t),onEnter:t=>this.killEnter(t)},this.stateMachine=new St(this.patrolState),this.model_=function(){const t=new W(new lt(1,1,1,6,6,6).spherify(.8).scale_(1,1.3,.8).selectBy((t=>t.y>.7)).scale_(3,1,1.5).selectBy((t=>t.y>.8)).scale_(1.5,8,2).texturePerSide(h.iron,h.iron,h.iron,h.iron,h.face,h.iron).all_().rotate_(Math.PI).translate_(0,5).computeNormals(!0).done_(),h.face);return t.position.set(0,54,2),t}(),this.model_.add_(this.lightObject)}spawn(t){I.pointLightAttenuation.set(.005,.001,.4),this.isSpawned=!0,this.setFarthestPoint(t),this.position.set(this.farthestPoint.position),this.currentNode=this.farthestPoint;const e=this.currentNode.getPresentSiblings();this.nextNode=e[Math.floor(Math.random()*e.length)],this.stateMachine.setState(this.patrolState)}playSong(){const t=()=>{for(const t of V)this.songPlayer.playNote(x.currentTime+t[2],t[1],t[4]-10,[T,N][t[0]],x.currentTime+t[2]+t[3])};this.songPlayer.volume_.gain.cancelScheduledValues(x.currentTime),this.songPlayer.volume_.gain.setValueAtTime(1,x.currentTime),t(),this.songInterval=setInterval(t,6e3)}stopSong(){this.songPlayer.volume_.gain.linearRampToValueAtTime(0,x.currentTime+1),this.songInterval&&clearInterval(this.songInterval)}increaseAggression(){this.aggression<=.9&&(this.aggression+=.1)}decreaseAggression(){this.aggression*=.4}getMaxUnseenFramesBeforeGivingUp(){return 600+600*this.aggression}getSpeed(){return Math.min(.15+.23*this.aggression,.3)}updateNodeDistanceData(){this.nextNodeDifference.subtractVectors(this.nextNode.position,this.position),this.nextNodeDistance=this.nextNodeDifference.magnitude,this.nextNodeDirection=this.nextNodeDifference.clone_().normalize_(),this.currentNodeDifference.subtractVectors(this.currentNode.position,this.position)}updateLight(e,i){this.lightObject.position.z=e,I.pointLightPosition.set(this.lightObject.worldMatrix.transformPoint(new t(0,0,0))),I.pointLightPosition.y=i}update_(t){if(!this.isSpawned)return this.model_.position.y=-1e3,this.currentNode=vt[0],void this.stopSong();this.updateNodeDistanceData(),this.stateMachine.getState().onUpdate(t),this.model_.position.set(this.position)}patrolUpdate(t){if(this.checkVision(t),t.closestNavPoint.hidingPlace?this.updateLight(4,2):this.updateLight(8,9),!this.handleDoor(t)){if(this.nextNodeDistance>6-2*this.getSpeed())this.travelingDirection.lerp(this.nextNodeDirection,this.getSpeed()/4),this.moveInTravelingDirection();else{this.moveInTravelingDirection();let e=this.currentNode;if(this.currentNode=this.nextNode,Math.random()<this.aggression/3)this.advancePathToNode(t.closestNavPoint);else{let t=this.currentNode.getPresentSiblings();t.length>1&&(t=t.filter((t=>{const i=this.currentNode.door&&t.door&&this.currentNode.roomNumber===t.roomNumber&&this.currentNode!==t&&!this.currentNode.hidingPlace;return t!==e&&!i}))),this.nextNode=t[Math.floor(Math.random()*t.length)]}}this.nextNode||(this.nextNode=this.currentNode)}}moveInTravelingDirection(){if(this.nextNodeDistance>.3){const e=2.5;this.position.add_(this.travelingDirection.clone_().normalize_().scale_(this.getSpeed())),this.model_.lookAt((new t).addVectors(this.position,this.travelingDirection)),this.position.y=e+.1*Math.sin(this.position.x+this.position.z),this.position.y<2.402&&(this.footstepDebounce&&clearTimeout(this.footstepDebounce),this.footstepDebounce=setTimeout((()=>this.footstepPlayer.playNote(x.currentTime,38+4*Math.random(),60,S,x.currentTime+1)),40)),this.currentInterval++,this.pannerNode.positionX.value=this.position.x,this.pannerNode.positionZ.value=this.position.z}else this.position.set(this.nextNode.position)}handleRoomEntering(t,e){this.currentNode.roomNumber===t.closestNavPoint.roomNumber&&setTimeout((()=>{t.isHiding?this.stateMachine.setState(this.searchState,t):this.stateMachine.getState()!==this.chaseState&&this.stateMachine.setState(this.chaseState,t)}),e)}handleDoor(t){if(this.currentNode.door&&this.nextNode.door&&this.currentNode.roomNumber===this.nextNode.roomNumber&&this.currentNode!==this.nextNode){if(-1===this.currentNode.door.openClose||this.currentNode.door.isAnimating)return this.currentNode.door.isAnimating||(this.currentNode.door.pullLever(!0),this.model_.lookAt(this.nextNode.position),this.travelingDirection.set(this.nextNodeDirection),this.handleRoomEntering(t,2e3)),!0;this.currentNode.door.isAnimating||this.handleRoomEntering(t,100)}return!1}chaseEnter(e){this.stopSong(),this.playSong(),this.pathCache=[],this.positionInPathCache=0,this.advancePathToNode(e.closestNavPoint),this.nextNode=this.pathCache[1]??this.currentNode,this.positionInPathCache++;const i=(new t).subtractVectors(this.nextNode.position,this.position).normalize_();this.travelingDirection.set(i),this.unseenFrameCount=0}chaseUpdate(e){if(this.updateLight(8,9),this.handleDoor(e))return;if(this.unseenFrameCount++,this.checkVision(e),this.unseenFrameCount>=this.getMaxUnseenFramesBeforeGivingUp()&&(this.stateMachine.setState(this.fleeState,e),this.increaseAggression()),this.currentNode.hidingPlace&&e.isHiding&&e.closestNavPoint===this.currentNode||(this.currentNode===e.closestNavPoint||this.nextNode===e.closestNavPoint)&&(new t).subtractVectors(this.position,e.feetCenter).magnitude<7)return void this.stateMachine.setState(this.killState,e);const i=this.nextNode.door?1:6;this.nextNodeDistance>i-2*this.getSpeed()?(this.travelingDirection.lerp(this.nextNodeDirection,this.getSpeed()/4),this.moveInTravelingDirection()):(this.moveInTravelingDirection(),this.currentNode=this.nextNode,this.advancePathToNode(e.closestNavPoint),this.nextNode||(this.nextNode=this.currentNode))}advancePathToNode(t){if(this.lastPlayerNode===t&&this.pathCache.length)return this.nextNode=this.pathCache[this.positionInPathCache],void(this.positionInPathCache<this.pathCache.length-1&&this.positionInPathCache++);this.positionInPathCache=0,this.lastPlayerNode=t;this.pathCache=((t,e)=>{if(t===e)return[t];const i=[{node_:t,path_:[t]}],r=new Set;for(;i.length>0;){const{node_:t,path_:s}=i.shift();r.add(t);for(const n of t.getPresentSiblings())if(!r.has(n)){const t=[...s,n];if(n===e)return t;i.push({node_:n,path_:t})}}})(this.currentNode,t)}killEnter(e){this.killFrameCount=0,this.stopSong(),e.isFlashlightOn=!1;const i=(new t).set(e.feetCenter);this.model_.lookAt(i),this.footstepPlayer.playNote(x.currentTime,70,100,S,x.currentTime+1),this.footstepPlayer.playNote(x.currentTime+.1,1,80,F,x.currentTime+5),e.isHiding&&e.unhide(),e.isFrozen_=!0}killUpdate(t){this.updateLight(5,5),this.killFrameCount++,t.health-=.1,this.killFrameCount===this.killFrames&&(this.spawn(t),t.isFrozen_=!1,this.decreaseAggression())}checkVision(e){const i=(r,s)=>{const n=r?.getAllSiblings()[s];if(n&&(!n.door||1===n.door.openClose||!n.roomNumber||!r.roomNumber||n.roomNumber!==r.roomNumber))if(n===e.closestNavPoint){const i=s<2&&Math.abs(e.differenceFromNavPoint.x)<5.75||s>1&&Math.abs(e.differenceFromNavPoint.z)<5.75,r=s<2&&Math.abs(this.currentNodeDifference.x)<5.75||s>1&&Math.abs(this.currentNodeDifference.z)<5.75;if(!e.isHiding&&i&&r){if((new t).subtractVectors(e.feetCenter,this.position).magnitude<60)return this.unseenFrameCount=0,this.stateMachine.getState()!==this.chaseState&&this.stateMachine.setState(this.chaseState,e),!0}}else i(n,s)},r=Math.abs(e.differenceFromNavPoint.x)<5.75||Math.abs(e.differenceFromNavPoint.z)<5.75,s=Math.abs(this.currentNodeDifference.x)<5.75||Math.abs(this.currentNodeDifference.z)<5.75;if(!e.isHiding&&this.currentNode===e.closestNavPoint&&r&&s)return this.unseenFrameCount=0,void(this.stateMachine.getState()!==this.chaseState&&this.stateMachine.setState(this.chaseState,e));i(this.currentNode,0)||i(this.currentNode,1)||i(this.currentNode,2)||i(this.currentNode,3)}searchEnter(){this.spotsSearched=0}searchUpdate(t){if(this.updateLight(5,5),t.isHiding||this.stateMachine.setState(this.chaseState,t),this.nextNodeDistance>.5)this.travelingDirection.lerp(this.nextNodeDirection,1),this.moveInTravelingDirection();else{const e=300;if(this.spotSearchFrameCount<=e)this.model_.rotate_(0,this.spotSearchFrameCount>100?-.02:.02,0),this.spotSearchFrameCount++;else{if(this.spotsSearched++,this.currentNode=this.nextNode,this.currentNode===t.closestNavPoint&&Math.random()<Math.min(this.aggression,.3))return void this.stateMachine.setState(this.killState,t);this.nextNode=this.currentNode.getPresentSiblings().find((t=>t.hidingPlace)),this.updateNodeDistanceData(),this.spotSearchFrameCount=0,this.spotsSearched>=2&&Math.random()>.25&&(this.stateMachine.setState(this.fleeState,t),this.increaseAggression())}}}setFarthestPoint(e){let i=0;const r=new t;vt.forEach((t=>{const s=r.subtractVectors(e.feetCenter,t.position).magnitude;s>i&&(i=s,this.farthestPoint=t)}))}fleeEnter(t){this.stopSong(),this.setFarthestPoint(t),this.advancePathToNode(this.farthestPoint),this.nextNode=this.pathCache[0],this.updateNodeDistanceData()}fleeUpdate(){this.updateLight(3,9),this.nextNodeDistance>1?(this.travelingDirection.lerp(this.nextNodeDirection,1),this.moveInTravelingDirection()):(this.moveInTravelingDirection(),this.currentNode=this.nextNode,this.advancePathToNode(this.farthestPoint),this.nextNode||(this.nextNode=this.currentNode),this.nextNode===this.farthestPoint&&this.stateMachine.setState(this.patrolState))}}class Nt{constructor(){this.gridFaces=[],this.hasPlayerLeftElevator=!1,this.hasEnemySpawned=!1,this.sfxPlayer=new b,this.isGameEnded=!1,this.playerDoorDifference=new t,this.playerHidingPlaceDifference=new t,this.deathTriggered=!1,this.sfxPlayer.volume_.connect(_),this.scene=new H,this.doors=[new wt(48,4.75,33.75,-1,-1,!0),new wt(48,4.75,68.75,-1,-1,!0),new wt(48,4.75,103.75,-1,-1,!0),new wt(-4,4.75,26.25,1,1,!0),new wt(4,4.75,33.75,-1,-1,!0),new wt(-4,4.75,61.25,1,1,!0),new wt(4,4.75,68.75,-1,-1,!0),new wt(-4,4.75,96.25,1,1,!0),new wt(4,4.75,103.75,-1,-1,!0),new wt(-48,4.75,26.25,1,1,!0),new wt(-48,4.75,61.25,1,1,!0),new wt(-48,4.75,96.25,1,1,!0),new wt(2.5,4.75,124,-1,-1,!1,!0),new wt(-2.5,4.75,124,1,-1,!1,!0)];const e=function(e){const i=[Mt(new t(44,2.5,36),1301,e[0]),Mt(new t(44,2.5,71),1302,e[1]),Mt(new t(44,2.5,106),1303,e[2]),Mt(new t(0,2.5,24),1304,e[3]),Mt(new t(0,2.5,36),1305,e[4]),Mt(new t(0,2.5,59),1306,e[5]),Mt(new t(0,2.5,71),1307,e[6]),Mt(new t(0,2.5,94),1308,e[7]),Mt(new t(0,2.5,106),1309,e[8]),Mt(new t(-44,2.5,24),1310,e[9]),Mt(new t(-44,2.5,59),1311,e[10]),Mt(new t(-44,2.5,94),1312,e[11])];let r=[...i];const s=r[Math.floor(Math.random()*(r.length-1))];s.door.isLocked=!0,function e(i){const s=bt.includes(i.roomNumber)?-1:1,n=[[{position:new t(4.25*s,1.75,-7*s),rotation_:new t(0,Math.PI/4)},{position:new t(-4.5*s,.5,-7.5*s),rotation_:new t(0,-Math.PI/2)},{position:new t(-5.5*s,.75,-12.75*s),rotation_:new t(0,0,Math.PI/2)}],[{position:new t(5.25*s,-.75,-12*s),rotation_:new t(0,0,Math.PI/2)},{position:new t(-1*s,-.5,8.4*s),rotation_:new t(0,0,-Math.PI/2)},{position:new t(-2*s,.8,-13.5*s),rotation_:new t(Math.PI/3*-s,0,0)}]];let o;r=r.filter((t=>t!==i));let a=0;const h=new t;r.forEach((t=>{const e=h.subtractVectors(i.position,t.position).magnitude;e>a&&(a=e,o=t)})),Math.random()<=.3&&(o=r[Math.floor(Math.random()*(r.length-1))]);const l=i.getPresentSiblings().find((t=>t.hidingPlace)),c=l.getPresentSiblings().find((t=>t.hidingPlace)),d=Math.floor(2*Math.random()),u=Math.floor(3*Math.random()),m=[l,c][d];r.length>3?(m.item=new _t((new t).addVectors(m.position,n[d][u].position),n[d][u].rotation_,o.roomNumber),o.door.isLocked=!0):r.length>2?m.item=new _t((new t).addVectors(m.position,n[d][u].position),n[d][u].rotation_,1313):m.item=new _t((new t).addVectors(m.position,n[d][u].position),n[d][u].rotation_),Pt.push(m.item),r.length>=1&&e(o)}(s);const n=new xt(new t(44,2.5,12)),o=new xt(new t(-44,2.5,12)),a=new xt(new t(44,2.5,118)),h=new xt(new t(-44,2.5,118)),l=new xt(new t(0,2.5,12)),c=new xt(new t(0,2.5,47.5)),d=new xt(new t(0,2.5,82.5)),u=new xt(new t(0,2.5,118.5),void 0,1313);u.item=new _t(new t(0,1.4,20).add_(u.position),new t,-1),Pt.push(u.item);const m=new xt(new t(44,2.5,47.5)),p=new xt(new t(44,2.5,82.5)),g=new xt(new t(-44,2.5,47.5)),f=new xt(new t(-44,2.5,82.5));return a.rightSibling=h,a.belowSibling=n,h.belowSibling=o,n.rightSibling=o,l.insertBetweenHor(n,o),u.insertBetweenHor(a,h),d.insertBetweenVert(u,l),c.insertBetweenVert(d,l),m.insertBetweenVert(a,n),m.attachThisRightToOtherLeft(c),p.insertBetweenVert(a,m),p.attachThisRightToOtherLeft(d),g.insertBetweenVert(h,o),g.attachThisLeftToOtherRight(c),f.insertBetweenVert(h,g),f.attachThisLeftToOtherRight(d),i[0].insertBetweenVert(m,n),i[1].insertBetweenVert(p,m),i[2].insertBetweenVert(a,p),i[9].insertBetweenVert(g,o),i[10].insertBetweenVert(f,g),i[11].insertBetweenVert(h,f),i[3].insertBetweenVert(c,l),i[4].insertBetweenVert(c,i[3]),i[5].insertBetweenVert(d,c),i[6].insertBetweenVert(d,i[5]),i[7].insertBetweenVert(u,d),i[8].insertBetweenVert(u,i[7]),vt.push(l,n,o,a,h),s}(this.doors).roomNumber,i=document.getElementById("c3d"),r=i.clientWidth/i.clientHeight;this.player=new B(new q(Math.PI/3,r,1,500),vt[0]),this.player.heldKeyRoomNumber=e,this.enemy=new Tt,this.elevator=new mt,window.addEventListener("resize",(()=>{if(this.player?.camera){const t=document.getElementById("c3d"),e=t.clientWidth/t.clientHeight;this.player.camera.projection=this.createProjectionMatrix(Math.PI/3,e,1,500)}}))}createProjectionMatrix(t,e,i,r){const s=Math.tan(.5*Math.PI-.5*t),n=1/(i-r);return new DOMMatrix([s/e,0,0,0,0,s,0,0,0,0,(i+r)*n,-1,0,0,i*r*n*2,0])}onEnter(){const t=new W(new lt(180,1,180,20,1,20).spreadTextureCoords(5,5).translate_(0,0,64).done_(),h.redCarpet),e=new W(new lt(170,1,160).translate_(0,12,65).done_().spreadTextureCoords(5,5),h.ceilingTiles),i=new W(gt(!0).translate_(0,0,6).done_(),h.wallpaper),r=new W(gt().translate_(0,0,6).done_(),h.wallpaper);this.scene.add_(...this.elevator.meshes,e,t,i,...this.doors,this.enemy.model_,...Pt.map((t=>t.mesh))),this.gridFaces=function(t){const e=[];return t.forEach((t=>{t.points_.map(m).forEach((i=>{e[i]||(e[i]=new Set),e[i].add(t)}))})),e}(at([t,r,this.elevator.bodyCollision])),this.player.cameraRotation.set(0,Math.PI,0),this.player.sfxPlayer.playNote(x.currentTime,60,70,E,x.currentTime+6),setTimeout((()=>{this.elevator.isOpenTriggered=!0,this.playElevatorSound()}),7e3)}onUpdate(){tmpl.innerHTML="",this.player.update(this.gridFaces),this.enemy.update_(this.player),this.elevator.update(),this.scene.updateWorldMatrix(),nt(this.player.camera,this.scene),this.elevator.isOpen||f(this.elevator.doorCollision,this.player),[this.player.closestNavPoint.door,this.doors[12],this.doors[13]].forEach(((t,i)=>{if(t){const r=this.playerDoorDifference.subtractVectors(this.player.feetCenter,t.placedPosition).magnitude;if(-1===t.openClose&&!t.isAnimating&&r<7&&f(t.closedDoorCollision,this.player),r<8){const s=this.player.normal.dot(this.playerDoorDifference.normalize_());(r<1||s<-.77)&&(t.isLocked?this.player.heldKeyRoomNumber===this.player.closestNavPoint.roomNumber?(tmpl.innerHTML+='<div style="font-size: 30px; text-align: center; position: absolute; bottom: 20px; width: 100%;">üóùÔ∏è &nbsp; Ëß£ÈîÅÂπ∂ÂºÄÈó®</div>',e.isConfirm&&(t.pullLever(),t.isLocked=!1,this.player.heldKeyRoomNumber=void 0,i>0&&(this.doors[12].pullLever(),this.doors[12].isLocked=!1,this.doors[13].pullLever(),this.doors[13].isLocked=!1))):tmpl.innerHTML+='<div style="font-size: 30px; text-align: center; position: absolute; bottom: 20px; width: 100%;">üîí &nbsp; Â∑≤‰∏äÈîÅ</div>':this.enemy.currentNode.door===t?tmpl.innerHTML+='<div style="font-size: 30px; text-align: center; position: absolute; bottom: 20px; width: 100%;">üö´</div>':(tmpl.innerHTML+=`<div style="font-size: 30px; text-align: center; position: absolute; bottom: 20px; width: 100%;">${-1===t.openClose?"ÂºÄÈó®":"ÂÖ≥Èó®"}</div>`,e.isConfirm&&t.pullLever()))}}})),this.doors.forEach((t=>{t.isAnimating&&t.update_()}));const i=this.player.closestNavPoint.hidingPlace;if(i){if(this.playerHidingPlaceDifference.subtractVectors(this.player.camera.position,i.position).magnitude<8){this.player.normal.dot(this.playerHidingPlaceDifference.normalize_())<-.77&&!this.player.isHiding&&(tmpl.innerHTML+='<div style="font-size: 30px; text-align: center; position: absolute; bottom: 20px; width: 100%;">Ë∫≤Ëóè</div>',e.isConfirm&&!e.prevConfirm&&this.player.hide(i))}}const r=this.player.closestNavPoint.item;if(r&&!r.isTaken){if(this.playerHidingPlaceDifference.subtractVectors(this.player.camera.position,r.mesh.position).magnitude<6){this.player.normal.dot(this.playerHidingPlaceDifference.normalize_())<-.9&&(r.roomNumber?-1===r.roomNumber?tmpl.innerHTML+='<div style="font-size: 30px; text-align: center; position: absolute; bottom: 20px; width: 100%;">üéÇ ËÆ∏‰∏™ÊÑø</div>':tmpl.innerHTML+=`<div style="font-size: 30px; text-align: center; position: absolute; bottom: 20px; width: 100%;">üóùÔ∏è ÊãæÂèñ ${r.roomNumber} Âè∑ÊàøÈó¥Èí•Âåô</div>`:tmpl.innerHTML+='<div style="font-size: 30px; text-align: center; position: absolute; bottom: 20px; width: 100%;">‰ΩøÁî®ÂåªÁñóÂåÖ</div>',e.isConfirm&&!e.prevConfirm&&(r.isTaken=!0,-1!==r.roomNumber&&(this.scene.remove_(r.mesh),this.sfxPlayer.playNote(x.currentTime,90,30,A,x.currentTime+1)),r.roomNumber&&(this.player.heldKeyRoomNumber=r.roomNumber,this.enemy.increaseAggression(),this.hasEnemySpawned||(I.pointLightAttenuation.set(.001,.001,.4),this.enemy.aggression=0,this.hasEnemySpawned=!0,this.enemy.spawn(this.player)),1313===r.roomNumber&&(this.enemy.isSpawned=!1,I.pointLightPosition.set(0,3.7,138)),-1===r.roomNumber&&(this.sfxPlayer.playNote(x.currentTime,120,30,A,x.currentTime+1),I.pointLightPosition.set(0,8,0),setTimeout((()=>{this.elevator.isOpenTriggered=!0,this.playElevatorSound()}),1e3))),r.roomNumber||this.player.heal()))}}this.hasPlayerLeftElevator||(new t).subtractVectors(this.player.feetCenter,vt[0].position).magnitude>17&&(this.hasPlayerLeftElevator=!0,this.elevator.isCloseTriggered=!0,this.playElevatorSound()),this.hasPlayerLeftElevator&&this.player.feetCenter.z<3&&(this.player.isFrozen_=!0,tmpl.innerHTML+='<div style="font-size: 40px; text-align: center; position: absolute; bottom: 20px; width: 100%;">‰Ω†Ëµ¢‰∫ÜÔºÅ</div>',this.isGameEnded||(this.isGameEnded=!0,this.elevator.isCloseTriggered=!0,this.playElevatorSound())),this.player.health<=0&&!this.deathTriggered&&(this.deathTriggered=!0,alert("‰Ω†Ê≠ª‰∫Ü"),location.reload())}playElevatorSound(){this.player.sfxPlayer.playNote(x.currentTime,60,70,z,x.currentTime+4),this.player.sfxPlayer.playNote(x.currentTime+.5,60,70,S,x.currentTime+2.5),this.player.sfxPlayer.playNote(x.currentTime+1.8,60,70,S,x.currentTime+2.5),this.sfxPlayer.playNote(x.currentTime,60,70,F,x.currentTime+1)}}let Ct=0;setTimeout((()=>{const t=document.getElementById("intro");t&&(t.style.display="none"),tmpl.innerHTML='<div style="font-size: 30px; text-align: center; position: absolute; bottom: 20px; width: 100%;">ÁÇπÂáªÂºÄÂßã</div>'}),3e3),document.onclick=async()=>{tmpl.requestPointerLock(),tmpl.innerHTML="",await async function(){h.wood=new i({texture:o.load_(await a('<svg width="512" height="512" xmlns="http://www.w3.org/2000/svg"><filter id="a"><feTurbulence type="fractalNoise" baseFrequency="0.1, 0.007" numOctaves="6" stitchTiles="stitch"/><feComposite in="s" operator="arithmetic" k2=".5" k3=".6"/><feComponentTransfer><feFuncA type="table" tableValues="0, .1, .2, .3, .4, .2, .4"/></feComponentTransfer><feDiffuseLighting color-interpolation-filters="sRGB" surfaceScale="3" lighting-color="#6e3f2b"><feDistantLight azimuth="110" elevation="48"/></feDiffuseLighting></filter><rect height="100%" width="100%" filter="url(#a)"/></svg>'))}),h.face=new i({texture:o.load_(await a('<svg style="filter: invert()" width="512" height="512" xmlns="http://www.w3.org/2000/svg"><filter id="a" x="-0.01%" primitiveUnits="objectBoundingBox" width="100%" height="100%"><feTurbulence seed="7" type="fractalNoise" baseFrequency="0.005" numOctaves="5" result="n"/><feComposite in="SourceAlpha" operator="in"/><feDisplacementMap in2="n" scale="0.9"/></filter><rect x="0" y="-14" width="100%" height="100%" id="l" filter="url(#a)"/><rect fill="#fff" width="100%" height="100%"/><use href="#l" x="22%" y="42" transform="scale(2.2, 1.2)"></use><use href="#l" x="-22%" y="42" transform="rotate(.1) scale(-2.2 1.2)"></use><rect fill="#777" x="220" y="230" width="50" height="50"/></svg>'))}),h.silver=new i({texture:o.load_(await d("",20))}),h.iron=new i({texture:o.load_(await d())}),h.marble=new i({texture:o.load_(await a('<svg width="512" height="512" xmlns="http://www.w3.org/2000/svg"><pattern id="a" width="256" height="256" patternUnits="userSpaceOnUse"><circle r="290" fill="#fff"/><path d="M0 0h128v256h128V128H0z"/></pattern><filter id="b"><feTurbulence baseFrequency=".04" numOctaves="5"/><feColorMatrix values="1 -1 0 0 0 1 -1 0 0 0 1 -1 0 0 0 0 0 0 0 0.3"/><feBlend in="SourceGraphic" mode="soft-light"/></filter><rect width="100%" height="100%" fill="url(#a)" filter="url(#b)"/></svg>'))}),h.ceilingTiles=new i({texture:o.load_(await a('<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512"><pattern id="b" width="512" height="256" patternUnits="userSpaceOnUse"><path d="M8 7h502v248H8z"/></pattern><filter id="a"><feTurbulence type="fractalNoise" baseFrequency=".8" numOctaves="8"/><feComposite in="SourceGraphic" operator="arithmetic" k2=".5" k3=".5"/><feComponentTransfer result="n"><feFuncA type="gamma" exponent="4"/></feComponentTransfer><feDiffuseLighting color-interpolation-filters="sRGB" lighting-color="#fff" surfaceScale="-1" result="d"><feDistantLight azimuth="40" elevation="55"/></feDiffuseLighting></filter><rect width="100%" height="100%" filter="url(#a)" fill="url(#b)"/></svg>'))}),h.elevatorPanel=new i({texture:o.load_(await c())}),h.redCarpet=new i({texture:o.load_(await a('<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512"><filter id="a"><feTurbulence type="fractalNoise" baseFrequency=".09" numOctaves="2"/><feDiffuseLighting color-interpolation-filters="sRGB" lighting-color="#600" result="d"><feDistantLight azimuth="90" elevation="55"/></feDiffuseLighting></filter><rect width="100%" height="100%" filter="url(#a)"/></svg>'))}),h.wallpaper=new i({texture:o.load_(await l(!0))}),h.greenPlasterWall=new i({texture:o.load_(await l())}),h.white=new i({texture:o.load_(await u("#bbb"))}),h.red=new i({texture:o.load_(await u("#b00"))});for(let e=1;e<=13;e++)h[e]=new i({texture:o.load_(await(t=`13${e.toString().padStart(2,"0")}`,d(`<text x="21%" y="42%" font-size="150px" style="transform: scaleY(1.5)">${t}</text>`,30)))});var t;o.bindTextures()}();const t=new Nt;t.onEnter(),function i(r){const s=r-Ct;s>=16.666666666666668&&(Ct=r-s%16.666666666666668,e.queryController(),t.onUpdate());requestAnimationFrame(i)}(0),document.onclick=()=>tmpl.requestPointerLock()};
